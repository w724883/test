require(["zepto","touchslider","tools","../common","ui","lazyload"],function(e,t,n,r,i){var s={init:function(){this.pagination=e("#pagination"),this.touchSlider=t({id:"indexFocus",begin:0,auto:!0,speed:600,timeout:5e3,direction:"left",align:"center",fixWidth:!0,before:function(){s.pagination.find(".active").removeClass("active")},after:function(e){s.pagination.find("span").eq(e).addClass("active")}}),this.$detail=e("#detail"),this.detailPrice=this.$detail.find(".J-price"),this.detailOriginal=this.$detail.find(".J-original"),this.setPagination(),this.bindEvent(),r.init(),r.bindTab(),this.json=e.parseJSON(e("#json-detail").html());var n=this.json.attr,i=this.$detail.find("ul.J-params"),o=i.first().data("params"),u=n[o],a=[];for(var f in u){var l=u[f];i.first().find("li:contains("+f+")").addClass("select"),a.push(f);for(var c in l)i.filter("[data-params="+c+"]").find("li:contains("+l[c][0]+")").addClass("select"),a.push(l[c][0]);break}this.setInfo(a)},bindEvent:function(){var t=this;e("body").on("tap",".J-like",function(t){r.bindLike(e(this))});var o=e("#login");o.on("tap",".J-submit",function(e){r.bindLogin(o)}),t.$detail.find("dd li").on("tap",function(n){if(e(this).hasClass("disable"))return!1;t.setParams(e(this))}),this.$detail.on("tap",".i-amount a",function(r){n.selectNumber(e(this),{inventory:t.info.inventory});var i=e(this).siblings("input").val();t.detailPrice.html(t.info.price*i),t.detailOriginal.html(t.info.original*i)}).on("blur",".i-amount input",function(r){n.selectNumber(e(this),{inventory:t.info.inventory});var i=e(this).val();t.detailPrice.html(t.info.price*i),t.detailOriginal.html(t.info.original*i)}),e(".detail .J-buy").on("tap",function(n){if(e(this).data("userid")){var r=s.getParams(t.$detail);r?e.post("/cart_create",r,function(e){e.code==200?i.confirm("购买成功！前去购物车？",function(e){e&&(window.location.href="/cart")}):i.alert(e.message)},"json").fail(function(e){i.alert(e)}):i.alert("请选择您要的商品信息")}else i.modal(e(".pop-login"))}),e(window).on("orientationchange",function(t){e(".center").center()}).trigger("orientationchange")},setPagination:function(){var t=e("#indexFocus li"),n="";for(var r=t.length-1;r>=0;r--)n+="<span></span>";this.pagination.html(n)},setParams:function(e){var t=this.json.attr,n=[],r=e.closest("ul").data("params"),i=e.html(),s=t[r][i],o=this.$detail.find("ul.J-params");e.addClass("select").siblings(".select").removeClass("select"),e.siblings(".disable").removeClass("disable");for(var u=0;u<o.length;u++){var a=o.eq(u).data("params");if(a!=r){o.eq(u).find("li").addClass("disable");if(s){var f=s[a];for(var l=0;l<f.length;l++)o.eq(u).find("li:contains("+f[l]+")").removeClass("disable")}}n.push(o.eq(u).find(".select").html())}this.setInfo(n)},getParams:function(t){var n=t.find(".J-params"),r={};for(var i=0;i<n.length;i++)if(n.eq(i).is("input"))if(n.eq(i).is(":hidden"))r[n.eq(i).data("params")]=n.eq(i).val();else{if(n.eq(i).val()<1||isNaN(n.eq(i).val()))return!1;r[n.eq(i).data("params")]=n.eq(i).val()}else{var s=n.eq(i).find(".select:not(.disable)");if(s.length==0)return!1;r[n.eq(i).data("params")]=e.trim(s.text())}return r},setInfo:function(e){var t=this.json.info;for(var n in t)if(n.split(",").sort().toString()==e.sort().toString()){var r=this.$detail.find(".i-amount input").val();this.detailPrice.html(t[n].price*r),this.detailOriginal.html(t[n].original*r),this.$detail.find(".J-inventory").text(t[n].inventory),this.info={price:t[n].price,original:t[n].original,inventory:t[n].inventory}}}};s.init()});