require(["zepto","../common","ui","serialize"],function(e,t,n,r){var i={init:function(){t.init(),this.$comment=e("#comment"),this.bindEvent()},bindEvent:function(){var r=this.$comment.find(".comment-desc span"),s=r.text();this.$comment.on("input","textarea",function(t){var n=e(this).val().length;r.text(s-n<0?0:s-n)}),this.$comment.on("tap",".icon-star-gray",function(t){e(this).addClass("icon-star-active").prevAll(".icon-star-gray").addClass("icon-star-active"),e(this).nextAll(".icon-star-active").removeClass("icon-star-active"),e(this).nextAll(".comment-status").html(e(this).data("text"))}),this.$comment.on("change",".upload-item input[type=file]",function(e){t.upload(this,"/comment_upload_img",{success:function(e){e.code==200?i.$comment.find(".comment-upload").prepend('<div class="upload-item active"><label><img data-original='+e.data+' /></label><a href="javascript:;"></a></div>').find("img").center():n.alert(e.message)},tips:function(e){n.alert.alert(e)}})}),this.$comment.on("tap",".upload-item .J-delete",function(t){var r=e(this).closest(".upload-item");n.confirm("你要删除上传的图片吗？",function(t){typeof t=="boolean"&&t&&e.post("/comment_img_delete","image_name="+r.find("img").data("original"),function(t){t.code==200?r.fadeOut(300,function(){e(this).remove()}):n.alert(t.message)},"json").fail(function(e){n.alert(e)})})}),this.$comment.on("tap",".upload-item img",function(t){var r=e(this);n.pop('<div class="comment-preview"><img data-original='+e(this).data("original")+" /></div>").find("img").contain()}),this.$comment.on("tap",".J-submit",function(t){var r={},s=i.$comment.find(".J-param");for(var o=0;o<s.length;o++)if(s.eq(o).is(":visible")){if(!e.trim(s.eq(o).val()))return n.alert(s.eq(o).data("error")),!1;r[s[o].name]=e.trim(s[o].value)}else r[s[o].name]=e.trim(s[o].value);r.comment_num=i.$comment.find(".comment-star .icon-star-active").length;if(!r.comment_num)return n.alert(i.$comment.find(".comment-star").data("error")),!1;r.comment_image=i.$comment.find(".comment-upload img").map(function(){return e(this).data("original")}).get().join("&"),e.post("/create_comment",r,function(e){e.code==200?window.location.href="/order?param=4":n.alert(e.message)},"json").fail(function(e){n.alert(e)})})}};i.init()});