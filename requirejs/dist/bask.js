require(["zepto","ui","../common","lazyload"],function(e,t,n){var r={init:function(){this.page=0,r.getTemplete(this.page),r.bindEvent()},bindEvent:function(){var i=e("#appraiseForm"),s=i.find(".appraise-img");e("#moreBtn").on("click",function(t){e(this).text("加载中..."),r.getTemplete(++r.page)}),e("#bask").on("click",".J-praise",function(t){r.setPraise(e(this))}),e("#bask").on("tap",".J-like",function(t){n.bindLike(e(this))}),i.on("click",".icon-star-gray",function(t){var n=e(this).addClass("icon-star").prevAll(".icon-star-gray").addClass("icon-star").length;e(this).nextAll(".icon-star-gray").removeClass("icon-star"),i.find(".comment-text").html(e(this).data("appraise")),i.find(".btn-ok").data("star",n+1)}),i.on("click",".img-del span",function(n){var r=e(this).closest(".img-del");e.post("/delete_image","image_name="+r.find("img").data("original"),function(e){e.code==200?r.remove():t.alert(e.message)},"json").fail(function(e){t.alert(e)})}),i.on("change","input[type=file]",function(e){n.upload(this,"/upload_face_edit",{tips:function(e){t.alert(e)},before:function(){i.find("label").append('<i class="icons icon-btn-loading"></i>')},success:function(e){var t="";for(var n=0;n<e.data.length;n++)t+='<div class="img-del"><img class="lazy" data-original="'+e.data[n]+'" /><span><i class="icons icon-delet"></i></span></div>';s.append(t).find(".lazy").lazyload({effect:"fadeIn"})},complete:function(){i.find(".icon-btn-loading").remove()}})}),i.on("click",".btn-ok",function(n){var r={};r.order_sn=e(this).data("ordersn"),r.goods_id=e(this).data("goodsid"),r.comment_num=e(this).data("star"),r.contents=e.trim(i.find(".appraise-textarea textarea").val());var s=i.find(".appraise-img img");r.comment_image=[];for(var o=0;o<s.length;o++)r.comment_image.push(s.eq(o).data("original"));r.comment_image=r.comment_image.join("&");if(!r.comment_num)return t.alert("先对商品进行评星才能提交哦！"),!1;if(!r.contents)return t.alert("先输入评论才能提交哦！"),!1;if(r.contents.length>200)return t.alert("评论字数小于200字才能提交哦！"),!1;e.post("/comment_add",r,function(n){n=e.parseJSON(n),n.code==200?window.location.href="/item/"+r.goods_id:t.alert(n.message)}).fail(function(e){t.alert(e)})})},baskTemplate:function(e){var t="";for(var n=0;n<e.length;n++)t+='<li><div class="animation-translate show-item"><a href="/item/'+e[n].goods_id+'" class="overflow show-img">'+'<img class="lazy nocenter animation-scale" data-original="'+e[n].comment_img+'" />'+"</a>"+'<div class="show-info">'+'<a href="" class="c-707070 show-desc">'+e[n].contents+"</a>"+'<div class="show-content">'+'<div class="show-head">'+'<a href="javascript:;"><img class="center" data-original="'+e[n].face+'" alt="'+e[n].username+'"></a>'+"</div>"+'<a href="javascript:;" class="c-889f40 show-user">'+e[n].username+"</a>"+'<div class="f-right J-like like data-goodsid="'+e[n].id+'" data-userid="'+e[n].user_id+'">'+'<i class="icons animation-scale icon-favorites"></i><span class="c-c0c0c0">'+e[n].praise+"</span>"+"</div>"+"</div>"+"</div>",e[n].comment_num>4?t+='<i class="icons show-flag icon-praise-good"></i>':t+='<i class="icons show-flag icon-praise-normal"></i>',t+="</div></li>";return t},getTemplete:function(n){e.post("/get_bask","action=bask&page="+n,function(n){if(n.code==200){n=n.data;if(n.length){var i=[],s=e("#bask"),o=s.find("ul");for(var u=0;u<n.length;u++)i[u%o.length]||(i[u%o.length]=[]),i[u%o.length].push(n[u]);for(var a=0;a<i.length;a++){var f=r.baskTemplate(i[a]),l=e(f).appendTo(o.eq(a));l.find(".lazy").lazyload({threshold:200,effect:"fadeIn"},function(e){e.closest("li").addClass("animation")}),l.find(".center").center()}}else t.alert(n.message)}else t.alert(n.message)},"json").always(function(){e("#moreBtn").text("查看更多")}).fail(function(e){t.alert(e)})},setPraise:function(n){var r=n.data("praise");e.post("/praise_z","common_id="+r,function(e){e.code==200?n.find("span").text(e.data):t.alert(e.message)},"json").fail(function(e){t.alert(e)})}};r.init()});