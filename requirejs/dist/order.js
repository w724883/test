require(["zepto","ui","../common","tools"],function(e,t,n,r){var i={init:function(){n.init(),this.$order=e("#order"),this.bindEvent(),this.setParams()},bindEvent:function(){this.$order.on("tap",".J-drop",function(t){e(this).find(".arrow").toggleClass("arrow-down"),e(this).next(".section-drop").fadeToggle(300)}),this.$order.on("change",".checkbox input[type=checkbox]",function(t){var n=i.$order.find(".J-pay");e(this).closest(".J-pay").length&&(e(this).prop("checked")?n.find(".balance-pay input:first").prop("checked",!0):n.find(".balance-pay input").prop("checked",!1)),i.setParams()}),this.$order.on("change",".balance-icons",function(t){e(this).siblings(".balance-icons").find("input").prop("checked",!1).closest(".J-pay").find("input[type=checkbox]").prop("checked",!0)}),this.$order.on("tap",".J-accounts",function(n){n.preventDefault();var r=i.$order.find("input[name]");r.each(function(){if(e(this).is("[type=hidden]")&&e(this).val()=="")return t.alert(e(this).data("error")),!1});if(i.total>0){var s=i.$order.find("input[name=pay_platform]");if(!s.prop("checked"))return t.alert("请选择支付平台支付余额！"),!1}i.$order.submit()}),this.$order.on("tap",".i-amount a",function(t){r.selectNumber(e(this),{inventory:1e4,limit:0}),i.setParams()}).on("blur",".i-amount input",function(t){r.selectNumber(e(this),{inventory:1e4,limit:0}),i.setParams()}),this.$order.on("blur",".J-voucher input",function(n){var r=e(this),s=r.closest(".J-voucher").find(".f-right").html("");r.data("amount",0),e.post("/common/common/check_voucher","voucher_code="+e.trim(r.val()),function(e){if(e.code==200){if(e.data.price*1>i.total*1)return t.alert("使用优惠劵 ￥"+e.data.price+" 已超出总计金额！"),r.val(""),!1;if(e.data.min_use_price*1<i.total*1)return t.alert("总计金额大于 ￥"+e.data.min_use_price+" 才能使用优惠劵 ！"),r.val(""),!1;r.data("amount",e.data.price).attr("name","voucher_code"),s.removeClass("arrow").html("￥"+e.data.price)}else t.alert(e.message)},"json").always(function(){i.setParams()}).fail(function(e){t.alert(e)})})},setParams:function(){var t=this.$order.find(".J-amount").html(),n=this.$order.find(".J-fare").html(),r=this.$order.find("input[name=pay_score]"),s=this.$order.find("input[name=pay_balance]"),o=this.$order.find("input[name=voucher_code]"),u=this.$order.find(".J-addition input");i.total=t*1+n*1,u.each(function(){i.total+=e(this).val()*e(this).data("price")}),r.prop("checked")&&(i.total-=r.data("amount")),s.prop("checked")&&(i.total-=s.data("amount"),i.$order.find(".J-balance").text(i.total>0?0:-1*i.total)),o.data("amount")&&(i.total-=o.data("amount")),this.$order.find(".J-total").text("￥"+(i.total>0?i.total:0))}};i.init()});